{% extends "sprout-forms/_layouts/base" %}
{% import "_includes/forms" as forms %}
{% import "sprout-forms/_includes/macros" as sproutForms %}

{% set crumbs = [
  { label: "Forms"|t, url: cpUrl('sprout-forms/forms') }
] %}

{% set fieldLayout = form.getFieldLayout() %}
{% set formFields = {} %}

{% set formTabs = {} %}
{% for tab in fieldLayout.getTabs() %}
  {% set formTabs = formTabs|merge({(tab.name) : {
    label: tab.name,
    url: '#sproutforms-tab-'~tab.id}
    })
  %}
{% endfor %}

{% set title = form.name %}
{% set saveShortcutRedirect = continueEditingUrl %}
{% set fullPageForm = true %}
{% set selectedTab = '{{fieldLayout.getTabs()[0].name}}' %}

{% block actionButton %}
  <input type="hidden" name="action" value="sprout-forms/forms/save-form">
  {{ redirectInput('sprout-forms/forms') }}
  <input type="hidden" id="formId" name="id" value="{{ form.id is defined ? form.id : '' }}">

  <div class="btngroup submit first">
    <input type="submit" class="btn submit" value="{{ 'Save'|t('sprout-forms') }}">
    {% if form.id != null %}
    <div class="btn submit menubtn"></div>
    <div class="menu">
      <ul>
        <li><a class="formsubmit" data-redirect="{{('sprout-forms/forms/edit/'~form.id)|hash}}">{{ "Save and continue editing"|t }} <span class="shortcut">âŒ˜S</span></a></li>
        <li><a class="formsubmit" data-redirect="{{ 'sprout-forms/forms/edit/'~form.id|hash}}" data-param='saveAsNew' data-value="true">{{ "Save as a new form"|t }}</a></li>
      </ul>
      <hr>
      <ul>
        <li><a class="formsubmit error" data-action="sprout-forms/forms/delete-form" data-confirm="Are you sure you want to delete this form?" data-redirect="{{ 'sprout-forms/forms'|hash }}">{{ "Delete"|t('sprout-forms') }}</a></li>
      </ul>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block tabs %}
  {% if formTabs is defined and formTabs %}
    {% include "sprout-forms/_includes/tabs" %}
  {% endif %}
{% endblock %}

{% block content %}
  {# When we add tabs we need add a for loop here #}
  <div id="sproutforms-fieldlayout-container">

    {# let's add the tabs and fields to the dropped divs #}
    {% if fieldLayout %}
      {% for tab in fieldLayout.getTabs() %}
        {{ sproutForms.tab(tab, tab.getFields(), not loop.first) }}
      {% endfor %}
    {% endif %}

    <div id="deletedFieldsContainer" class="hidden"></div>

  </div>
{% endblock %}

{% block details %}
  <div class="editform-sidebar">
    {% include 'sprout-forms/forms/_sidebar/settings' %}

  </div>

  <hr>

  <div class="sproutforms-sidebar-callout">

    {% if formId is defined %}
      <h3>{{ "One line of code"|t }}</h3>

      <p><input class="text nicetext fullwidth" type="text" id="display-form-code" value="{% verbatim %}{{ craft.sproutForms.displayForm('{% endverbatim %}{{ form.handle }}{% verbatim %}') }}{% endverbatim %}"></p>
      <hr>
      <h3>{{ "100% Control"|t }}</h3>
      <p>{{ 'Customize your form using <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/customization/template-overrides" target="_blank">Template Overrides</a>, <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/customization/rendering-options" target="_blank">Rendering Options</a>, additional <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/customization/rendering-options" target="_blank">Fields</a>, Notifications, or <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/examples/custom-html" target="_blank">Custom HTML</a>.'|t|raw }}</p>
     {% endif %}

   </div>


{% endblock %}

{% do view.registerAssetBundle("craft\\web\\assets\\fields\\FieldsAsset") %}
{% do view.registerAssetBundle("barrelstrength\\sproutforms\\web\\assets\\forms\\FormsAsset") %}
{% do view.registerAssetBundle("barrelstrength\\sproutforms\\web\\assets\\dragula\\DragulaAsset") %}

{% js %}
  {% if not form.handle %}
    new Craft.HandleGenerator('#name', '#handle');
  {% endif %}

  new Craft.AdminTable({
    tableSelector: '#formFields',
    noObjectsSelector: '#noFormfields',
    sortable: true,
    reorderAction: 'sprout-forms/fields/reorderFields',
    deleteAction: 'sprout-forms/fields/deleteField'
  });

  $(document).ready(function() {

    $("#maindiv").css("height","600px");

    $("input#display-form-code")
    .focus(function() { $(this).select(); } )
    .mouseup(function (e) {e.preventDefault(); });

    var tabs = {{ fieldLayout.getTabs()|json_encode()|raw }};

    var continueEditing = "{{ ('sprout-forms/forms/edit/'~form.id)|hash }}";

    new Craft.SproutForms.FieldLayoutEditor(tabs, continueEditing);

  });
{% endjs %}