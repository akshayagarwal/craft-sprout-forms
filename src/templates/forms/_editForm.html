{% extends "sproutforms/_layouts/base" %}
{% import "_includes/forms" as forms %}

{% set crumbs = [
	{ label: "Forms"|t, url: url('sprout-forms/forms') }
] %}

{% set pages = form.getFieldLayout().getTabs() %}
{% set tabs = {
	formfields:  {
		label: pages[0].name,
		url: '#sproutforms-tab',
	},
	Add:  {
		label: "+ Add"|t,
		url: '#add-field',
	},
} %}

{% set title = form.name %}
{% set saveShortcutRedirect = continueEditingUrl %}
{% set fullPageForm = true %}
{% set selectedTab = '{{pages[0].name}}' %}

{% block saveButton %}

{% macro tab(tabName, tabFields) %}
	<div id="sproutfield" data-type="barrelstrength\sproutforms\integrations\sproutforms\fields\PlainText" class="" data-id="150">
		<div id="fields-fullName-field" class="field plaintext fullName-field" style="width: 40%;">
				<div class="heading">
					<img width="30" height="30" src="http://craft3.dev/site/images/input.svg">
					<label for="fields-fullName">Plain Text</label>
				</div>
			</div>
		<input class="id-input" type="hidden" name="fieldLayout[{{tabName}}][]" value="150">
		<ul class="settings">
			<li><a id="field-150" data-fieldid="150" href="#" tabindex="0">edit</a></li>
			<li><a href="#">delete</a></li>
			</ul>
	</div>
	<div class="fld-tab">
		<div class="tabs">
			<div class="tab sel{% if customizableTabs %} draggable{% endif %}">
				<span>{{ tabName }}</span>
				{% if customizableTabs %}
					<a class="settings icon" title="{{ 'Edit'|t }}"></a>
				{% endif %}
			</div>
		</div>
		<div class="fld-tabcontent">
			{% for field in tabFields %}
				<div class="fld-field{% if field.required %} fld-required{% endif %}" data-id="{{ field.id }}">
					<a class="settings icon" title="{{ 'Edit'|t }}"></a>
					<span>{{ field.name }}</span>
					<input class="id-input" type="hidden" name="fieldLayout[{{ tabName|e('url') }}][]" value="{{ field.id }}">
					{% if field.required %}<input class="required-input" type="hidden" name="requiredFields[]" value="{{ field.id }}">{% endif %}
				</div>
			{% endfor %}
		</div>
	</div>
{% endmacro %}

<input type="hidden" name="action" value="sprout-forms/forms/save-form">
{{ redirectInput('sprout-forms/forms') }}
<input type="hidden" id="formId" name="id" value="{{ form.id is defined ? form.id : '' }}">

<div class="btngroup submit first">
	<input type="submit" class="btn submit" value="{{ 'Save'|t('sproutforms') }}">
	{% if form.id != null %}
	<div class="btn submit menubtn"></div>
	<div class="menu">
		<ul>
			<li><a class="formsubmit" data-redirect="{{('sprout-forms/forms/edit/'~form.id)|hash}}">{{ "Save and continue editing"|t }} <span class="shortcut">âŒ˜S</span></a></li>
			<li><a class="formsubmit" data-redirect="{{'sprout-forms/forms/edit/'~form.id|hash}}" data-param='saveAsNew' data-value="true">{{ "Save as a new form"|t }}</a></li>
		</ul>
	</div>
	{% endif %}
</div>

{% endblock %}

{% block main %}
<style type="text/css">
	.sproutfield{
		background:#e3e5e8;
		width: 70%;
		height: 150px;
	}
	.sproutfield ul li{
		float:right;
		display: inline-block;
		padding: 5px;
		margin: 10px;
	}
</style>
<div class="grid first" data-max-cols="3" id ="maindiv">
	<div class="item" data-position="left" data-colspan="2">
		{# When we add tabs we need add a for loop here #}
		<div id="fields" class="pane">

			{% if tabs is defined and tabs %}
			{% include "_includes/tabs" %}
			{% endif %}

			<div id="sproutforms-tab" data-tabname="{{pages[0].name}}" data-tabid="{{pages[0].id}}" class="hidden">
				{#% include 'sproutforms/forms/_tabs/fieldlayoutdesigner' %#}
				<br>
					<div class='parent'>
						<h1>Drag and drop here</h1>
						<div class='sprout-wrapper'>
							<div id='left-copy' class='sprout-container'>
								{# here will be the fields #}
								{#% set fieldLayout = form.getFieldLayout() %}
								{% if fieldLayout %}
									{% for tab in fieldLayout.getTabs() %}
										{{ macros.tab(tab.name, tab.getFields()) }}
									{% endfor %}
								{% endif %#}
							</div>
						</div>
					</div>
				<br>
			</div>

		</div>

		{% if formId is defined %}
		<div class="pane">
			<div class="grid formcontrol">

				<div class="item oneline" data-max-colspan="1">

					<p><strong>{{ "One line of code"|t }}</strong></p>

					{% if craft.request.getSegment(3) == 'new' %}

					<input class="text nicetext fullwidth" type="text" id="display-form-code" value="{% verbatim %}{{ craft.sproutForms.displayForm('yourFormHandle') }}{% endverbatim %}">

					{% else %}

					<input class="text nicetext fullwidth" type="text" id="display-form-code" value="{% verbatim %}{{ craft.sproutForms.displayForm('{% endverbatim %}{{ form.handle }}{% verbatim %}') }}{% endverbatim %}">

					{% endif %}

				</div>

				<div class="item totalcontrol" data-max-colspan="1">
					<p><strong>{{ "100% Control"|t }}</strong></p>
					<p>{{ 'Customize your form using <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/customization/template-overrides" target="_blank">Template Overrides</a>, <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/customization/rendering-options" target="_blank">Rendering Options</a>, additional <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/customization/rendering-options" target="_blank">Fields</a>, Notifications, or <a href="http://sprout.barrelstrengthdesign.com/craft-plugins/forms/docs/examples/custom-html" target="_blank">Custom HTML</a>.'|t|raw }}</p>
				</div>

			</div>
		</div>
		{% endif %}

	</div>

	<div class="editform-sidebar item" data-position="right">
		<div class="pane meta">
			{% include 'sproutforms/forms/_sidebar/settings' %}

			<div class="deleteform field">
				<div class="heading"></div>
				<div class="input">
					<div class="right">
						<input type="button" class="btn small formsubmit" value="Delete" data-action="sprout-forms/forms/delete-form" data-confirm="Are you sure you want to delete this form, all of it's fields, and all of it's data?" data-redirect="{{('sprout-forms/forms')|hash}}">
					</div>
				</div>
			</div>
		</div>

		{% set sproutFieldsIsInstalled           = craft.sproutforms.isPluginInstalled('sproutfields') %}
		{% set sproutReportsIsInstalled          = craft.sproutforms.isPluginInstalled('sproutreports')%}
		{% set sproutEmailIsInstalled            = craft.sproutforms.isPluginInstalled('sproutemail') %}
		{% set sproutInvisibleCaptchaIsInstalled = craft.sproutforms.isPluginInstalled('sproutinvisiblecaptcha') %}

		{% if not sproutFieldsIsInstalled or not sproutReportsIsInstalled or not sproutEmailIsInstalled or not
		sproutInvisibleCaptchaIsInstalled %}

		<div class="pane">
			<h6>{{"Improve your forms"|t}}</h6>

			{% if not sproutFieldsIsInstalled %}
			<p class="light"><a href="http://sprout.barrelstrengthdesign.com/craft-plugins/fields" target="_blank">Sprout
				Fields</a> &ndash; Validate Email Addresses, Phone Numbers, and URLs. Capture hidden values for your workflows
				and analytics. </p>
			{% endif %}

			{% if not sproutReportsIsInstalled %}
			<p class="light"><a href="http://sprout.barrelstrengthdesign.com/craft-plugins/reports" target="_blank">Sprout
				Reports</a> &ndash; Generate reports and export your form data as a CSV.</p>
			{% endif %}

			{% if not sproutEmailIsInstalled %}
			<p class="light"><a href="http://sprout.barrelstrengthdesign.com/craft-plugins/email" target="_blank">Sprout
				Email</a> &ndash; Send multiple, customized notification emails to admins and users.</p>
			{% endif %}

			{% if not sproutInvisibleCaptchaIsInstalled %}
			<p class="light"><a href="http://sprout.barrelstrengthdesign.com/craft-plugins/invisible-captcha" target="_blank">Sprout
				Invisible Captcha</a> &ndash; Provides several user-friendly methods to protect your forms from vile spammers
				and evil robots.</p>
			{% endif %}

		</div>

		{% endif %}

		{% if sproutInvisibleCaptchaIsInstalled %}
		<div class="pane">
			<h6>Protect your forms</h6>

			{% if craft.sproutForms.isInvisibleCaptchaEnabled %}
			<p class="light">{{"This form is protected by Sprout Invisible Captcha."|t}}
				<a href="{{ cpUrl('settings/plugins/sproutinvisiblecaptcha') }}">{{"Edit&nbsp;settings"|t|raw }}.</a></p>
			{% else %}
			<p class="light">
				<a href="{{ cpUrl('settings/plugins/sproutinvisiblecaptcha') }}">{{"Enable Sprout Invisible Captcha"|t|raw
					}}.</a> {{" to protect this form from vile spammers and evil robots."|t}}</p>
			{%endif%}
		</div>
		{% endif %}


	</div>
</div>

{% endblock %}

{% do view.registerAssetBundle("craft\\web\\assets\\fields\\FieldsAsset") %}
{% do view.registerAssetBundle("barrelstrength\\sproutforms\\assetbundles\\FormAsset") %}
{% do view.registerAssetBundle("barrelstrength\\sproutforms\\assetbundles\\DragulaAsset") %}

{% js %}
	{% if not form.handle %}
		new Craft.HandleGenerator('#name', '#handle');
	{% endif %}

	new Craft.AdminTable({
		tableSelector: '#formFields',
		noObjectsSelector: '#noFormfields',
		sortable: true,
		reorderAction: 'sproutForms/fields/reorderFields',
		deleteAction: 'sproutForms/fields/deleteField'
	});

	$(document).ready(function() {

		$("#maindiv").css("height","600px");

		$("input#display-form-code")
		.focus(function() { $(this).select(); } )
		.mouseup(function (e) {e.preventDefault(); });

		new SproutField();

	});
{% endjs %}
